<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MVRS Web Wallet — Fixed</title>

<!-- QR and Chart CDN -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--bg:#071029;--card:#0f1b2b;--muted:#9fb0d1;--accent:#6be6b8;--panel:#0c2030;--btn:#4CAF50}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#03101b,#071029);color:#e6f0fb}
.container{max-width:1100px;margin:18px auto;padding:12px}
.header{display:flex;gap:14px;align-items:center}
.logo{width:76px;height:76px;border-radius:12px;background:#071a27;display:flex;align-items:center;justify-content:center;overflow:hidden}
.logo img{width:100%;height:100%;object-fit:cover}
.title h1{margin:0;font-size:20px}
.title p{margin:4px 0 0;color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.small{color:var(--muted);font-size:13px}
.addr{font-family:monospace;background:linear-gradient(90deg,#031827,transparent);padding:8px;border-radius:8px;display:inline-block}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
button{background:var(--btn);color:#042014;border:none;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
input[type="text"],input[type="number"],textarea{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit}
.tx-list{max-height:360px;overflow:auto;margin-top:10px;display:flex;flex-direction:column;gap:8px}
.tx{background:var(--panel);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.meta{color:var(--muted);font-size:12px;margin-top:6px}
.footer{margin-top:18px;color:var(--muted);text-align:center;font-size:13px}
.kv{display:flex;flex-direction:column;align-items:flex-start}
.note{font-size:13px;color:var(--muted);margin-top:8px}
.modal-root{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999}
.modal-card{background:#071827;padding:18px;border-radius:12px;max-width:520px;width:92%;color:#eaf5ff}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo"><img id="logoImg" src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Dec%2011,%202025,%2009_34_05%20PM.png" alt="MVRS"></div>
    <div class="title"><h1>MultiVerse (MVRS) Wallet</h1><p>Web wallet • Local only</p></div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Wallet Address</div>
            <div class="addr" id="walletAddress">(none)</div>
            <div class="note">Address derived from seed. Keep seed private.</div>
          </div>
          <div style="text-align:right">
            <div class="small">Balance</div>
            <div style="font-size:18px;font-weight:700" id="balanceDisplay">0 MVRS</div>
            <div class="small" style="margin-top:6px">Seed: <span id="seedStatus">Not loaded</span></div>
          </div>
        </div>

        <div style="margin-top:12px" class="controls">
          <button id="btnCreate">Create Wallet</button>
          <button id="btnRecover" class="ghost">Recover Wallet</button>
          <button id="btnExport" class="ghost">Export Wallet</button>
          <input id="importFile" type="file" accept="application/json" style="display:inline-block" />
        </div>

        <div style="margin-top:12px" class="controls">
          <input id="sendAmount" type="number" placeholder="Amount (MVRS)" />
          <input id="sendTo" type="text" placeholder="Recipient address" />
          <button id="btnSend">Send</button>
          <button id="btnReceive" class="ghost">Receive</button>
        </div>

        <div class="note" style="margin-top:10px"><strong>Security:</strong> Everything is local. Export seed and wallet to back up.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Transaction History</h3>
          <div class="small">Saved locally</div>
        </div>
        <div class="tx-list" id="txList"><div class="tx">No transactions yet.</div></div>
      </div>
    </div>

    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Market (simulated)</div>
            <div style="font-weight:700" id="priceDisplay">$0.12</div>
            <div class="small" id="changeDisplay">0.00%</div>
          </div>
          <div style="width:200px"><canvas id="priceChart" width="200" height="120"></canvas></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="btnTick" class="ghost">Simulate Tick</button>
          <button id="btnAutoPrice" class="ghost">Start Price</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h4 style="margin:0">Receive / QR</h4><div class="small">Scan to pay</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap">
          <div id="qr" style="width:160px;height:160px;background:#071e2d;border-radius:8px;display:flex;align-items:center;justify-content:center"></div>
          <div style="flex:1">
            <div class="small">Address</div>
            <div class="addr" id="qrAddress">-</div>
            <div style="margin-top:8px" class="controls">
              <button id="btnCopy" class="ghost">Copy</button>
              <button id="btnDownloadQR" class="ghost">Download QR</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0">Seed / Backup</h4>
        <div class="note">Create or recover a 12-word seed. Keep it secret.</div>
        <div style="margin-top:8px" class="controls">
          <button id="btnCreateSeed" class="ghost">Create Seed</button>
          <button id="btnRecoverSeed" class="ghost">Recover from Seed</button>
          <button id="btnShowSeed" class="ghost">Show Seed</button>
        </div>
      </div>

    </div>
  </div>

  <div class="footer">MVRS Web Wallet — Local only — Use for testing & small amounts</div>
</div>

<!-- modal -->
<div id="modalRoot" class="modal-root">
  <div class="modal-card" id="modalCard"></div>
</div>

<script>
/* ===== MVRS Wallet Fixed Implementation =====
   - Local-only storage via localStorage
   - Create / Recover seed -> derive simple address
   - Buttons wired and tested
*/

// storage key
const STORAGE_KEY = "mvrs_v3_state";

// simple 256-word list subset for demo (not BIP39 exact)
const WORDS = ("abandon ability able about above absent absorb abstract absurd abuse access accident account accuse achieve acid acoustic acquire across act action actor actress actual adapt add addict address adjust admit adult advance advice aerobic affair afford afraid again age agent agree ahead aim air airport aisle alarm album alcohol alert alien all alley allow almost alone alpha already also alter always amateur amaze among amount amuse analyst anchor ancient anger angle angry animal ankle announce annual another answer anticipate anxiety any apart apology appear apple april arch arctic area arena argue arm armed armor army around arrange arrest arrive arrow art article artist ash ask aspect aspire asset assist assume athlete atom attack attend attitude attract auction audit august aunt author auto autumn average avian avoid awake aware award aware away awesome awful axis").split(" ");

// state
let state = {
  seed: null,
  address: null,
  balance: 0,
  transactions: [],
  priceHistory: []
};

// helpers
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadState(){ const j=localStorage.getItem(STORAGE_KEY); if(j){ try{ Object.assign(state, JSON.parse(j)); }catch(e){console.warn("bad state");}}}

// sha256 hex
async function sha256hex(msg){
  const enc = new TextEncoder();
  const data = enc.encode(msg);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const bytes = new Uint8Array(hash);
  return Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function deriveAddress(seed){
  if(!seed) return null;
  const h = await sha256hex(seed);
  return "MVRS" + h.slice(0,8).toUpperCase();
}

// UI refs
const addrEl = document.getElementById("walletAddress");
const balEl = document.getElementById("balanceDisplay");
const seedStatusEl = document.getElementById("seedStatus");
const txListEl = document.getElementById("txList");
const qrEl = document.getElementById("qr");
const qrAddrEl = document.getElementById("qrAddress");

// modal
function showModal(html){
  document.getElementById("modalCard").innerHTML = html;
  document.getElementById("modalRoot").style.display = "flex";
}
function closeModal(){ document.getElementById("modalRoot").style.display = "none"; }

// initialize simple price history
function ensurePriceHistory(){
  state.priceHistory = state.priceHistory || [];
  while(state.priceHistory.length < 20) state.priceHistory.push((0.08 + Math.random()*0.18).toFixed(4));
}

// render txs
function renderTxs(){
  txListEl.innerHTML = "";
  if(!state.transactions || state.transactions.length===0){
    txListEl.innerHTML = '<div class="tx">No transactions yet.</div>';
    return;
  }
  for(const t of state.transactions){
    const el = document.createElement("div");
    el.className = "tx";
    el.innerHTML = `<div><strong>${t.type.toUpperCase()}</strong> ‣ ${t.amount} MVRS</div><div class="meta">${t.time}${t.to? " • To: "+t.to : ""}</div>`;
    txListEl.appendChild(el);
  }
}

// render QR
function renderQR(){
  qrEl.innerHTML = "";
  const a = state.address || "MVRS-none";
  qrAddrEl.textContent = a;
  QRCode.toCanvas(a, {width:150, margin:1}).then(canvas => { qrEl.appendChild(canvas); }).catch(()=>{ qrEl.textContent = a; });
}

// refresh UI
function refreshUI(){
  loadState();
  addrEl.textContent = state.address || "(none)";
  balEl.textContent = (state.balance||0) + " MVRS";
  seedStatusEl.textContent = state.seed ? "Loaded" : "Not loaded";
  renderTxs();
  renderQR();
  saveState();
}

// generate 12-word seed (demo)
function generateSeed(){
  const s=[];
  for(let i=0;i<12;i++){ s.push(WORDS[Math.floor(Math.random()*WORDS.length)]); }
  return s.join(" ");
}

// Create wallet action
document.getElementById("btnCreate").addEventListener("click", ()=>{
  const seed = generateSeed();
  const html = `<h3>Create new wallet</h3>
    <div class="note">Write down these 12 words and keep them secret. Anyone with them can access your wallet.</div>
    <textarea style="width:100%;height:120px;margin-top:8px;padding:8px;background:#05121a;border-radius:8px;border:1px solid rgba(255,255,255,0.04);color:#eaf5ff" id="seedText">${seed}</textarea>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button id="confirmCreateBtn">Confirm & Use</button>
      <button class="ghost" onclick="closeModal()">Close</button>
    </div>`;
  showModal(html);
  // wire confirm button after modal inserted
  setTimeout(()=>{
    document.getElementById("confirmCreateBtn").addEventListener("click", async ()=>{
      const seedVal = document.getElementById("seedText").value.trim();
      if(!seedVal){ alert("Seed empty"); return; }
      state.seed = seedVal;
      state.address = await deriveAddress(state.seed);
      state.balance = 0;
      state.transactions = [];
      saveState();
      closeModal();
      refreshUI();
      alert("Wallet created. SAVE YOUR SEED SECURELY.");
    });
  },50);
});

// Recover wallet action
document.getElementById("btnRecover").addEventListener("click", ()=>{
  const html = `<h3>Recover wallet</h3>
    <div class="note">Paste your 12-word seed phrase below.</div>
    <textarea id="recoverSeed" style="width:100%;height:120px;margin-top:8px;padding:8px;background:#05121a;border-radius:8px;border:1px solid rgba(255,255,255,0.04);color:#eaf5ff"></textarea>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button id="confirmRecoverBtn">Recover</button>
      <button class="ghost" onclick="closeModal()">Close</button>
    </div>`;
  showModal(html);
  setTimeout(()=>{
    document.getElementById("confirmRecoverBtn").addEventListener("click", async ()=>{
      const seedVal = document.getElementById("recoverSeed").value.trim();
      if(!seedVal){ alert("Enter seed"); return; }
      state.seed = seedVal;
      state.address = await deriveAddress(state.seed);
      // Do NOT auto-set balance/txs here; leave them zero until user imports backup JSON or manually adds receive amounts.
      state.balance = state.balance || 0;
      state.transactions = state.transactions || [];
      saveState();
      closeModal();
      refreshUI();
      alert("Recovered address: " + state.address + ". If you have a wallet export JSON, import it to restore balance & history.");
    });
  },50);
});

// Create seed quick (button)
document.getElementById("btnCreateSeed").addEventListener("click", async ()=>{
  const s = generateSeed();
  state.seed = s;
  state.address = await deriveAddress(s);
  state.balance = 0; state.transactions=[];
  saveState(); refreshUI();
  showModal(`<h3>Your seed phrase</h3><div class="note">Write it down and keep it safe.</div><textarea style="width:100%;height:120px;margin-top:8px">${s}</textarea><div style="display:flex;justify-content:flex-end;margin-top:8px"><button onclick="closeModal()">Close</button></div>`);
});

// Recover from prompt
document.getElementById("btnRecoverSeed").addEventListener("click", ()=>{
  const s = prompt("Paste your 12-word seed phrase:");
  if(!s) return;
  state.seed = s.trim();
  deriveAddress(state.seed).then(addr=>{
    state.address = addr;
    state.balance = state.balance || 0;
    state.transactions = state.transactions || [];
    saveState(); refreshUI(); alert("Recovered address: " + addr);
  });
});

// show seed
document.getElementById("btnShowSeed").addEventListener("click", ()=>{
  if(!state.seed) return alert("No seed loaded");
  showModal(`<h3>Your seed phrase</h3><div class="note">Keep it secret.</div><textarea style="width:100%;height:120px;margin-top:8px">${state.seed}</textarea><div style="display:flex;justify-content:flex-end;margin-top:8px"><button onclick="closeModal()">Close</button></div>`);
});

// send
document.getElementById("btnSend").addEventListener("click", ()=>{
  const amt = Number(document.getElementById("sendAmount").value);
  const to = document.getElementById("sendTo").value.trim();
  if(!to || !amt || amt <= 0) return alert("Enter valid recipient and amount");
  if(amt > state.balance) return alert("Insufficient balance");
  state.balance -= amt;
  state.transactions.unshift({type:"send", amount:amt, to, time:new Date().toLocaleString()});
  saveState(); refreshUI();
  document.getElementById("sendAmount").value=""; document.getElementById("sendTo").value="";
  alert("Recorded send: " + amt + " MVRS to " + to);
});

// receive modal
document.getElementById("btnReceive").addEventListener("click", ()=>{
  const html = `<h3>Receive MVRS</h3><div class="note">Share this address with sender or scan the QR.</div>
    <div style="margin-top:8px"><div class="small">Address</div><div class="addr">${state.address || "(none)"}</div></div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center"><input id="recvAmt" type="number" placeholder="Amount received" /><button id="confirmRecv">Add Received</button><button class="ghost" onclick="closeModal()">Close</button></div>`;
  showModal(html);
  setTimeout(()=>{
    document.getElementById("confirmRecv").addEventListener("click", ()=>{
      const v = Number(document.getElementById("recvAmt").value);
      if(!v || v<=0) return alert("Enter amount");
      state.balance += v;
      state.transactions.unshift({type:"receive", amount:v, to: state.address, time:new Date().toLocaleString()});
      saveState(); refreshUI(); closeModal(); alert("Added received amount locally.");
    });
  },50);
});

// export / import
document.getElementById("btnExport").addEventListener("click", ()=>{
  const out = {seed: state.seed||null, address: state.address, balance: state.balance, transactions: state.transactions};
  const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download=(state.address||"mvrs")+"_wallet.json"; a.click(); URL.revokeObjectURL(url);
});
document.getElementById("importFile").addEventListener("change", function(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = function(ev){
    try{
      const data = JSON.parse(ev.target.result);
      if(data.seed) state.seed = data.seed;
      if(data.address) state.address = data.address;
      if(typeof data.balance === "number") state.balance = data.balance;
      if(Array.isArray(data.transactions)) state.transactions = data.transactions;
      saveState(); refreshUI(); alert("Imported wallet JSON");
    }catch(err){ alert("Invalid file"); }
  }; r.readAsText(f);
});

// copy address
document.getElementById("btnCopy").addEventListener("click", ()=>{ if(!state.address) return alert("No address"); navigator.clipboard?.writeText(state.address).then(()=>alert("Copied")); });

// download QR
document.getElementById("btnDownloadQR").addEventListener("click", ()=>{
  const canvas = document.querySelector("#qr canvas"); if(!canvas) return alert("No QR");
  const url = canvas.toDataURL("image/png"); const a=document.createElement("a"); a.href=url; a.download=(state.address||"mvrs")+"_qr.png"; a.click();
});

// simple price chart
let priceChart=null;
function initChart(){
  ensurePriceHistory();
  const ctx = document.getElementById("priceChart").getContext("2d");
  priceChart = new Chart(ctx, {type:'line', data:{labels:state.priceHistory.map((_,i)=>i), datasets:[{label:'Price', data:state.priceHistory.map(x=>parseFloat(x)), borderColor:'#6be6b8', backgroundColor:'rgba(107,230,184,0.06)', tension:0.3}]}, options:{responsive:true,maintainAspectRatio:false,scales:{x:{display:false}}}});
  updatePriceUI();
}
function updatePriceUI(){
  const last = Number(state.priceHistory[state.priceHistory.length-1]||0.12);
  document.getElementById("priceDisplay").textContent = "$"+last.toFixed(4);
  const prev = Number(state.priceHistory[state.priceHistory.length-2]||last);
  const pct = ((last-prev)/prev*100).toFixed(2);
  const el = document.getElementById("changeDisplay"); el.textContent = (pct>0?"+":"")+pct+"%"; el.style.color = pct>=0? "#6be6b8":"#ff8b8b";
  if(priceChart){ priceChart.data.datasets[0].data = state.priceHistory.map(x=>parseFloat(x)); priceChart.update(); }
}
function simulateTick(){ const last = Number(state.priceHistory[state.priceHistory.length-1]||0.12); const next = Math.max(0.001, last*(1+(Math.random()-0.5)*0.08)); state.priceHistory.push(next.toFixed(4)); if(state.priceHistory.length>60) state.priceHistory.shift(); saveState(); updatePriceUI(); }
let autoPrice=null;
document.getElementById("btnTick").addEventListener("click", simulateTick);
document.getElementById("btnAutoPrice").ad
